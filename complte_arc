# Life Decision Coach - Complete System Architecture

## Executive Architecture Overview

```mermaid
graph TB
    subgraph "User Layer"
        USER[ðŸ‘¤ User]
        UI[ðŸ–¥ï¸ React Frontend]
        MOBILE[ðŸ“± Mobile Interface]
    end
    
    subgraph "API Gateway Layer"
        GATEWAY[ðŸšª Kong API Gateway]
        AUTH[ðŸ” Authentication]
        RATE[â±ï¸ Rate Limiter]
        CACHE[ðŸ’¾ Redis Cache]
    end
    
    subgraph "5-Layer Core Architecture"
        subgraph "Layer 1: Life State Ingestion"
            FORM[ðŸ“ Structured Questionnaire]
            RESUME[ðŸ“„ Resume Parser]
            VALIDATE[âœ… Input Validator]
            LSV[ðŸ“Š Life State Vector]
        end
        
        subgraph "Layer 2: Reality Constraint Layer"
            NEO[(ðŸ•¸ï¸ Neo4j Constraint Graph)]
            VISA[ðŸ›‚ Visa Rules]
            EDU[ðŸŽ“ Education Requirements]
            AGE[ðŸ“… Age Limits]
            FEASIBLE[ðŸ” Feasibility Checker]
        end
        
        subgraph "Layer 3: Trajectory Intelligence"
            subgraph "3A: Trajectory Knowledge Graph"
                TKG[ðŸ—ºï¸ Career State Graph]
                TRANS[â†”ï¸ Transition Edges]
            end
            
            subgraph "3B: Empirical Models"
                QUANT[ðŸ“ˆ Quantile Regression]
                SURV[â³ Survival Analysis]
                BAYES[ðŸŽ¯ Bayesian Models]
            end
            
            subgraph "3C: RAG Context"
                RAG[ðŸ”„ RAG System]
                VDB[ðŸ§  Vector Database]
                LIVE[ðŸ“¡ Live Data APIs]
            end
            
            subgraph "3D: Outcome Envelopes"
                P10[ðŸ“‰ P10 Pessimistic]
                P50[ðŸ“Š P50 Median]
                P90[ðŸ“ˆ P90 Optimistic]
                PARETO[âš–ï¸ Pareto Frontier]
            end
        end
        
        subgraph "Layer 4: Risk & Regret Analysis"
            LOCKIN[ðŸ”’ Lock-In Detector]
            REGRET[ðŸ˜” Regret Computer]
            REVERSE[â†©ï¸ Reversibility Scorer]
            TDECAY[ðŸ“‰ Time-Decay Analysis]
        end
        
        subgraph "Layer 5: Explanation Layer"
            GPT4[ðŸ¤– GPT-4 API]
            PROMPT[ðŸ“ Constrained Prompts]
            EXPLAIN[ðŸ’¬ Plain English Output]
        end
    end
    
    subgraph "Data Storage Layer"
        POSTGRES[(ðŸ˜ PostgreSQL)]
        PINECONE[(ðŸŒ² Pinecone Vector DB)]
        S3[(â˜ï¸ S3 Model Storage)]
    end
    
    subgraph "External Data Sources"
        H1B[(ðŸ‡ºðŸ‡¸ H1B Database)]
        GLASSDOOR[(ðŸ’° Glassdoor API)]
        USCIS[(ðŸ›ï¸ USCIS API)]
        BLS[(ðŸ“Š BLS Job Data)]
        LINKEDIN[(ðŸ’¼ LinkedIn API)]
        NEWS[(ðŸ“° News APIs)]
    end
    
    subgraph "ML Pipeline"
        SPARK[âš¡ Spark ETL]
        TRAIN[ðŸ‹ï¸ Model Training]
        MLFLOW[ðŸ“¦ MLflow Versioning]
    end
    
    subgraph "Monitoring & Observability"
        DATADOG[ðŸ“Š Datadog]
        ARIZE[ðŸ” Arize ML Observability]
        LOGS[ðŸ“ Structured Logging]
    end
    
    %% User Flow
    USER --> UI
    USER --> MOBILE
    UI --> GATEWAY
    MOBILE --> GATEWAY
    
    %% API Gateway Flow
    GATEWAY --> AUTH
    GATEWAY --> RATE
    AUTH --> CACHE
    
    %% Layer 1 Flow
    CACHE --> FORM
    CACHE --> RESUME
    FORM --> VALIDATE
    RESUME --> VALIDATE
    VALIDATE --> LSV
    
    %% Layer 2 Flow
    LSV --> FEASIBLE
    NEO --> FEASIBLE
    VISA --> NEO
    EDU --> NEO
    AGE --> NEO
    
    %% Layer 3 Flow
    FEASIBLE --> TKG
    TKG --> TRANS
    TRANS --> QUANT
    TRANS --> SURV
    TRANS --> BAYES
    
    RAG --> VDB
    LIVE --> RAG
    VDB --> QUANT
    
    QUANT --> P10
    QUANT --> P50
    QUANT --> P90
    SURV --> P10
    SURV --> P50
    SURV --> P90
    BAYES --> PARETO
    
    %% Layer 4 Flow
    P10 --> LOCKIN
    P50 --> LOCKIN
    P90 --> LOCKIN
    LOCKIN --> REGRET
    PARETO --> REGRET
    REGRET --> REVERSE
    REVERSE --> TDECAY
    
    %% Layer 5 Flow
    TDECAY --> PROMPT
    LOCKIN --> PROMPT
    REGRET --> PROMPT
    PROMPT --> GPT4
    GPT4 --> EXPLAIN
    
    %% Data Storage
    LSV --> POSTGRES
    TKG --> POSTGRES
    P10 --> POSTGRES
    P50 --> POSTGRES
    P90 --> POSTGRES
    VDB --> PINECONE
    QUANT --> S3
    SURV --> S3
    BAYES --> S3
    
    %% External Data
    H1B --> LIVE
    GLASSDOOR --> LIVE
    USCIS --> LIVE
    BLS --> LIVE
    LINKEDIN --> LIVE
    NEWS --> LIVE
    
    %% ML Pipeline
    H1B --> SPARK
    GLASSDOOR --> SPARK
    LINKEDIN --> SPARK
    SPARK --> TRAIN
    TRAIN --> MLFLOW
    MLFLOW --> S3
    
    %% Monitoring
    GATEWAY --> DATADOG
    QUANT --> ARIZE
    SURV --> ARIZE
    BAYES --> ARIZE
    GPT4 --> LOGS
    
    %% Return to User
    EXPLAIN --> UI
    P10 --> UI
    P50 --> UI
    P90 --> UI
    PARETO --> UI
    
    %% Styling
    style LSV fill:#4A90E2,stroke:#333,stroke-width:3px
    style FEASIBLE fill:#E24A4A,stroke:#333,stroke-width:3px
    style P10 fill:#FF6B6B,stroke:#333,stroke-width:2px
    style P50 fill:#FFB84D,stroke:#333,stroke-width:2px
    style P90 fill:#50C878,stroke:#333,stroke-width:2px
    style GPT4 fill:#9B59B6,stroke:#333,stroke-width:3px
    style NEO fill:#FF9F43,stroke:#333,stroke-width:2px
    style POSTGRES fill:#336791,stroke:#333,stroke-width:2px
    style REGRET fill:#FF6B6B,stroke:#333,stroke-width:2px
    style LOCKIN fill:#E74C3C,stroke:#333,stroke-width:2px
```

## Detailed Component Architecture

### Layer 1: Life State Ingestion
```mermaid
graph LR
    subgraph "Input Sources"
        FORM[ðŸ“ Structured Form]
        PDF[ðŸ“„ Resume PDF]
        DOCX[ðŸ“„ Resume DOCX]
        JSON[ðŸ“„ API Input]
    end
    
    subgraph "Processing Pipeline"
        NER[ðŸ” Named Entity Recognition]
        PARSE[âš™ï¸ Document Parser]
        NORM[ðŸ”§ Data Normalizer]
        VALID[âœ… Schema Validator]
    end
    
    subgraph "Output"
        LSV[ðŸ“Š Life State Vector]
    end
    
    FORM --> VALID
    PDF --> NER
    DOCX --> NER
    JSON --> PARSE
    
    NER --> NORM
    PARSE --> NORM
    NORM --> VALID
    VALID --> LSV
    
    style LSV fill:#4A90E2,stroke:#333,stroke-width:3px
```

### Layer 2: Reality Constraint Graph
```mermaid
graph TB
    subgraph "Constraint Types"
        VISA[ðŸ›‚ Visa Constraints]
        EDU[ðŸŽ“ Education Requirements]
        AGE[ðŸ“… Age Limits]
        FIN[ðŸ’° Financial Thresholds]
        GEO[ðŸŒ Geographic Restrictions]
    end
    
    subgraph "Neo4j Graph Structure"
        NODES[ðŸ”µ Constraint Nodes]
        EDGES[â†”ï¸ Relationship Edges]
        PROPS[ðŸ“‹ Properties]
    end
    
    subgraph "Feasibility Engine"
        QUERY[ðŸ” Graph Query Engine]
        CHECK[âœ… Constraint Checker]
        FILTER[ðŸš« Path Filter]
    end
    
    VISA --> NODES
    EDU --> NODES
    AGE --> NODES
    FIN --> NODES
    GEO --> NODES
    
    NODES --> EDGES
    EDGES --> PROPS
    
    PROPS --> QUERY
    QUERY --> CHECK
    CHECK --> FILTER
    
    style FILTER fill:#E24A4A,stroke:#333,stroke-width:3px
```

### Layer 3: Trajectory Intelligence Core
```mermaid
graph TB
    subgraph "3A: Knowledge Graph"
        STATES[ðŸ¢ Career States]
        TRANSITIONS[â†”ï¸ Transition Probabilities]
        METADATA[ðŸ“Š Edge Metadata]
    end
    
    subgraph "3B: Empirical Models"
        KM[ðŸ“ˆ Kaplan-Meier]
        COX[âš¡ Cox Hazards]
        QUANTILE[ðŸ“Š Quantile Regression]
        BAYESIAN[ðŸŽ¯ Bayesian Inference]
    end
    
    subgraph "3C: RAG System"
        RETRIEVE[ðŸ” Document Retrieval]
        EXTRACT[âš™ï¸ Context Extraction]
        MODIFY[ðŸ”§ Probability Modifiers]
    end
    
    subgraph "3D: Outcome Computation"
        P10[ðŸ“‰ P10 Model]
        P50[ðŸ“Š P50 Model]
        P90[ðŸ“ˆ P90 Model]
        ENVELOPE[ðŸ“ˆ Trajectory Envelope]
    end
    
    STATES --> KM
    TRANSITIONS --> COX
    METADATA --> QUANTILE
    
    KM --> P10
    COX --> P50
    QUANTILE --> P90
    BAYESIAN --> ENVELOPE
    
    RETRIEVE --> EXTRACT
    EXTRACT --> MODIFY
    MODIFY --> P10
    MODIFY --> P50
    MODIFY --> P90
    
    P10 --> ENVELOPE
    P50 --> ENVELOPE
    P90 --> ENVELOPE
    
    style P10 fill:#FF6B6B,stroke:#333,stroke-width:2px
    style P50 fill:#FFB84D,stroke:#333,stroke-width:2px
    style P90 fill:#50C878,stroke:#333,stroke-width:2px
```

### Layer 4: Risk & Regret Analysis
```mermaid
graph TB
    subgraph "Lock-In Detection"
        BEFORE[ðŸ“Š Options Before]
        AFTER[ðŸ“Š Options After]
        DIFF[âž– Difference Analysis]
        SEVERITY[âš ï¸ Severity Scoring]
    end
    
    subgraph "Regret Computation"
        CHOSEN[âœ… Chosen Path]
        ALTERNATIVES[ðŸ”„ Alternative Paths]
        COUNTERFACTUAL[ðŸ”® Counterfactual Analysis]
        REGRET_SCORE[ðŸ˜” Regret Score]
    end
    
    subgraph "Reversibility Analysis"
        TIME_COST[â° Time Cost]
        FINANCIAL_COST[ðŸ’° Financial Cost]
        REPUTATION_COST[ðŸ‘¥ Reputation Cost]
        LEGAL_BARRIERS[âš–ï¸ Legal Barriers]
        REVERSIBILITY[â†©ï¸ Reversibility Score]
    end
    
    BEFORE --> DIFF
    AFTER --> DIFF
    DIFF --> SEVERITY
    
    CHOSEN --> COUNTERFACTUAL
    ALTERNATIVES --> COUNTERFACTUAL
    COUNTERFACTUAL --> REGRET_SCORE
    
    TIME_COST --> REVERSIBILITY
    FINANCIAL_COST --> REVERSIBILITY
    REPUTATION_COST --> REVERSIBILITY
    LEGAL_BARRIERS --> REVERSIBILITY
    
    style SEVERITY fill:#E74C3C,stroke:#333,stroke-width:2px
    style REGRET_SCORE fill:#FF6B6B,stroke:#333,stroke-width:2px
    style REVERSIBILITY fill:#F39C12,stroke:#333,stroke-width:2px
```

### Layer 5: Explanation System
```mermaid
graph LR
    subgraph "Input Data"
        TRAJECTORIES[ðŸ“ˆ Trajectory Data]
        RISKS[âš ï¸ Risk Analysis]
        CONSTRAINTS[ðŸš« Constraint Results]
        REGRETS[ðŸ˜” Regret Scores]
    end
    
    subgraph "LLM Processing"
        TEMPLATE[ðŸ“ Prompt Template]
        GPT4[ðŸ¤– GPT-4 API]
        VALIDATE[âœ… Response Validator]
    end
    
    subgraph "Output"
        EXPLANATION[ðŸ’¬ Plain English]
        CITATIONS[ðŸ“š Data Citations]
        WARNINGS[âš ï¸ Risk Warnings]
    end
    
    TRAJECTORIES --> TEMPLATE
    RISKS --> TEMPLATE
    CONSTRAINTS --> TEMPLATE
    REGRETS --> TEMPLATE
    
    TEMPLATE --> GPT4
    GPT4 --> VALIDATE
    VALIDATE --> EXPLANATION
    VALIDATE --> CITATIONS
    VALIDATE --> WARNINGS
    
    style GPT4 fill:#9B59B6,stroke:#333,stroke-width:3px
    style EXPLANATION fill:#2ECC71,stroke:#333,stroke-width:2px
```

## Data Flow Architecture

### Complete End-to-End Data Flow
```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant API
    participant L1 as Layer 1
    participant L2 as Layer 2
    participant L3 as Layer 3
    participant L4 as Layer 4
    participant L5 as Layer 5
    participant Neo4j
    participant PostgreSQL
    participant GPT4
    
    User->>Frontend: Input life state data
    Frontend->>API: POST /api/v1/life-state
    API->>L1: Create Life State Vector
    L1->>L1: Validate and normalize input
    L1->>PostgreSQL: Store life state
    L1-->>API: Return Life State Vector
    
    API->>L2: Check constraints
    L2->>Neo4j: Query constraint graph
    Neo4j-->>L2: Return feasible paths
    L2-->>API: Return filtered paths
    
    API->>L3: Compute trajectories
    L3->>L3: Run quantile regression
    L3->>L3: Apply survival analysis
    L3->>L3: Generate P10/P50/P90 envelopes
    L3->>PostgreSQL: Store trajectory results
    L3-->>API: Return trajectory envelopes
    
    API->>L4: Analyze risks and regret
    L4->>L4: Detect lock-in points
    L4->>L4: Compute regret scores
    L4->>L4: Calculate reversibility
    L4-->>API: Return risk analysis
    
    API->>L5: Generate explanation
    L5->>GPT4: Request explanation
    GPT4-->>L5: Return plain English
    L5->>L5: Validate explanation
    L5-->>API: Return explanation
    
    API-->>Frontend: Complete analysis results
    Frontend-->>User: Display trajectories & explanations
```

## Technology Stack Detail

### Frontend Stack
```mermaid
graph TB
    subgraph "React Frontend"
        REACT[âš›ï¸ React 18]
        TS[ðŸ“˜ TypeScript]
        TAILWIND[ðŸŽ¨ Tailwind CSS]
        D3[ðŸ“Š D3.js Visualizations]
        ROUTER[ðŸ›£ï¸ React Router]
        QUERY[ðŸ”„ React Query]
    end
    
    subgraph "Visualization Components"
        GRAPH[ðŸ•¸ï¸ Constraint Graph Viz]
        TRAJECTORY[ðŸ“ˆ Trajectory Charts]
        PARETO[âš–ï¸ Pareto Frontier]
        REGRET[ðŸ˜” Regret Heatmap]
    end
    
    REACT --> TS
    REACT --> TAILWIND
    REACT --> D3
    REACT --> ROUTER
    REACT --> QUERY
    
    D3 --> GRAPH
    D3 --> TRAJECTORY
    D3 --> PARETO
    D3 --> REGRET
```

### Backend Stack
```mermaid
graph TB
    subgraph "API Layer"
        FASTAPI[ðŸš€ FastAPI]
        PYDANTIC[ðŸ“‹ Pydantic Models]
        ASYNC[âš¡ Async/Await]
        CORS[ðŸŒ CORS Middleware]
    end
    
    subgraph "ML/Data Science"
        SKLEARN[ðŸ¤– Scikit-learn]
        LIFELINES[â³ Lifelines]
        PANDAS[ðŸ¼ Pandas]
        NUMPY[ðŸ”¢ NumPy]
        SCIPY[ðŸ§® SciPy]
    end
    
    subgraph "Database Drivers"
        PSYCOPG[ðŸ˜ Psycopg3]
        NEO4J_DRIVER[ðŸ•¸ï¸ Neo4j Driver]
        REDIS_PY[ðŸ’¾ Redis-py]
    end
    
    FASTAPI --> PYDANTIC
    FASTAPI --> ASYNC
    FASTAPI --> CORS
    
    SKLEARN --> PANDAS
    LIFELINES --> PANDAS
    PANDAS --> NUMPY
    NUMPY --> SCIPY
    
    FASTAPI --> PSYCOPG
    FASTAPI --> NEO4J_DRIVER
    FASTAPI --> REDIS_PY
```

### Infrastructure Stack
```mermaid
graph TB
    subgraph "Container Orchestration"
        DOCKER[ðŸ³ Docker]
        K8S[â˜¸ï¸ Kubernetes]
        HELM[â›µ Helm Charts]
    end
    
    subgraph "Cloud Services"
        AWS[â˜ï¸ AWS]
        S3[ðŸ“¦ S3 Storage]
        RDS[ðŸ—„ï¸ RDS PostgreSQL]
        EKS[â˜¸ï¸ EKS Cluster]
    end
    
    subgraph "Monitoring"
        DATADOG[ðŸ“Š Datadog]
        PROMETHEUS[ðŸ“ˆ Prometheus]
        GRAFANA[ðŸ“Š Grafana]
    end
    
    DOCKER --> K8S
    K8S --> HELM
    
    AWS --> S3
    AWS --> RDS
    AWS --> EKS
    
    K8S --> DATADOG
    K8S --> PROMETHEUS
    PROMETHEUS --> GRAFANA
```

## Security Architecture

### Authentication & Authorization
```mermaid
graph TB
    subgraph "Auth Flow"
        LOGIN[ðŸ” User Login]
        JWT[ðŸŽ« JWT Token]
        REFRESH[ðŸ”„ Token Refresh]
        LOGOUT[ðŸšª Logout]
    end
    
    subgraph "API Security"
        RATE_LIMIT[â±ï¸ Rate Limiting]
        CORS_POLICY[ðŸŒ CORS Policy]
        INPUT_VALID[âœ… Input Validation]
        SQL_INJECT[ðŸ›¡ï¸ SQL Injection Protection]
    end
    
    subgraph "Data Security"
        ENCRYPT[ðŸ”’ Data Encryption]
        PII_MASK[ðŸŽ­ PII Masking]
        AUDIT_LOG[ðŸ“ Audit Logging]
        GDPR[ðŸ‡ªðŸ‡º GDPR Compliance]
    end
    
    LOGIN --> JWT
    JWT --> REFRESH
    REFRESH --> LOGOUT
    
    JWT --> RATE_LIMIT
    RATE_LIMIT --> CORS_POLICY
    CORS_POLICY --> INPUT_VALID
    INPUT_VALID --> SQL_INJECT
    
    SQL_INJECT --> ENCRYPT
    ENCRYPT --> PII_MASK
    PII_MASK --> AUDIT_LOG
    AUDIT_LOG --> GDPR
```

## Deployment Architecture

### Production Deployment
```mermaid
graph TB
    subgraph "Load Balancer"
        ALB[âš–ï¸ Application Load Balancer]
        SSL[ðŸ”’ SSL Termination]
    end
    
    subgraph "Frontend Tier"
        CDN[ðŸŒ CloudFront CDN]
        S3_WEB[ðŸ“¦ S3 Static Hosting]
    end
    
    subgraph "API Tier"
        EKS_CLUSTER[â˜¸ï¸ EKS Cluster]
        API_PODS[ðŸš€ FastAPI Pods]
        HPA[ðŸ“ˆ Horizontal Pod Autoscaler]
    end
    
    subgraph "Data Tier"
        RDS_POSTGRES[ðŸ˜ RDS PostgreSQL]
        NEO4J_CLUSTER[ðŸ•¸ï¸ Neo4j Cluster]
        REDIS_CLUSTER[ðŸ’¾ Redis Cluster]
        S3_DATA[ðŸ“¦ S3 Data Lake]
    end
    
    subgraph "External Services"
        OPENAI[ðŸ¤– OpenAI API]
        DATA_SOURCES[ðŸ“Š External Data APIs]
    end
    
    ALB --> SSL
    SSL --> CDN
    CDN --> S3_WEB
    
    SSL --> EKS_CLUSTER
    EKS_CLUSTER --> API_PODS
    API_PODS --> HPA
    
    API_PODS --> RDS_POSTGRES
    API_PODS --> NEO4J_CLUSTER
    API_PODS --> REDIS_CLUSTER
    API_PODS --> S3_DATA
    
    API_PODS --> OPENAI
    API_PODS --> DATA_SOURCES
```

## Summary

This complete architecture diagram shows the Life Decision Coach system as a sophisticated, data-driven decision infrastructure that:

1. **Separates Concerns**: Clear 5-layer architecture with distinct responsibilities
2. **Ensures Data Quality**: Multiple validation and quality checks throughout
3. **Provides Transparency**: Full provenance tracking and confidence indicators
4. **Scales Efficiently**: Microservices architecture with proper caching and load balancing
5. **Maintains Security**: Comprehensive security measures and compliance
6. **Enables Monitoring**: Full observability across all system components

The system transforms high-stakes life decisions from subjective advice into quantified, data-driven analysis with honest uncertainty representation and regret-aware recommendations.
